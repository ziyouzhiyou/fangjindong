(function(){var _mAddcartObj=function(){this.init()};_mAddcartObj.prototype={init:function(){this.jsonpID=1000;this.sid=this.getCookie("sid")||'';this.USER_FLAG_CHECK=this.getCookie("USER_FLAG_CHECK")||'';},getCookie:function(c){var b,d=new RegExp("(^| )"+c+"=([^;]*)(;|$)");b=document.cookie.match(d);if(b){return unescape(b[2])}else{return null}},getLocId:function(){var wq_addr=(this.getCookie('wq_addr')||'').split('|');return wq_addr[1]||this.getCookie('jdAddrId')||'1_72_4137_0';},ajaxJsonp:function(opt){var me=this;var f="_mCartCbk_"+(++me.jsonpID);var b=document.createElement("script");var clear=function(){b.onerror=b.onload=null;me.removeElement(b);delete window[f];};window[f]=function(h){opt.callback&&opt.callback(h);clear();};b.onerror=function(){opt.onerror&&opt.onerror();clear();};b.onload=function(){opt.onload&&opt.onload();clear();};b.src=opt.url+"&callback="+f;document.getElementsByTagName("head")[0].appendChild(b);},removeElement:function(c){var b=c.parentNode;if(b){b.removeChild(c)}},ajax:function(c){var b;try{b=new ActiveXObject("Msxml2.XMLHTTP")}catch(f){try{b=new ActiveXObject("Microsoft.XMLHTTP")}catch(f){b=new XMLHttpRequest()}}
b.ajaxRunError=true;try{b.withCredentials=true}catch(f){}
try{b.open(c.method,c.url,c.async||true);if(c.timeout){setTimeout(function(){if(b.ajaxRunError){b.onreadystatechange=function(){};b.abort();c.timeoutFun&&c.timeoutFun();}},c.timeout)}
b.onreadystatechange=function(){if(b.readyState==4){if(b.status==200){b.ajaxRunError=false;var e=b.responseText;c.success&&c.success(e);}else{c.error&&c.error();}}};if(c.method=="GET"||c.method=="get"){b.send(null)}else{if(c.method=="POST"||c.method=="post"){b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.send(c.data)}}}catch(f){}},dealUrlParam:function(url,opt){var param=[];for(var k in opt){param.push(k+'='+opt[k])}
if(param.length>0){param=param.join('&');url+=(url.indexOf('?')>0?'&':'?')+param;}
return url;},addMjdCart:function(opt){var me=this;if(!opt.skuId){return;}
var _opt={wareId:opt.skuId,num:opt.num||1,source:opt.source,actId:opt.actId=='1'?"1":'',sid:opt.sid||me.sid,USER_FLAG_CHECK:opt.ufc||me.USER_FLAG_CHECK,ran:Math.random()};var ajaxOpt={url:me.dealUrlParam('https://p.m.jd.com/cart/add.json',_opt),method:"post",async:true,timeout:opt.timeout||5000,timeoutFun:function(){opt.timeoutFun&&opt.timeoutFun();},success:function(data){if(opt.actId=='1'){var jsonRes=JSON.parse(data);if(jsonRes.login==='0'){data='{"errId":"13","errMsg":"用户未登录","nextUrl":""}';}}
opt.sucFun&&opt.sucFun(data);},error:function(){opt.failFun&&opt.failFun();}};me.ajax(ajaxOpt);},getCommlist:function(optArr){var me=this,itemArr=[],commlistArr=[],commItem={},extendArr=[];optArr.forEach(function(el){commItem={};commItem.itemid=el.skuId||"";commItem.shopid=el.shopId||"";commItem.num=el.num||"1";commItem.skuId=el.skuId||"";commItem.itype=el.itype||"1";commItem.targetid=el.targetid||"0";commItem.packid=el.packid||"0";itemArr=[commItem.itemid,commItem.shopid,commItem.num,commItem.skuId,commItem.itype,commItem.targetid,commItem.packid];extendArr=[];if(el.giftpool){extendArr.push('giftpool:'+el.giftpool);}
if(el.locsuits){extendArr.push('locsuits:'+el.locsuits);}
if(el.deliveryItemId){extendArr.push('delivid:'+el.deliveryItemId);}
if(el.cm){extendArr.push('cm:'+el.cm);}
commlistArr.push(itemArr.join(",")+(extendArr.length?(','+extendArr.join("@@")):''));});return commlistArr.join("$");},addWqCart:function(opt){var me=this,_skuIds,_commlist,_commArr,url;if(opt.commArr&&opt.commArr.length){_commlist=me.getCommlist(opt.commArr);}else{_skuIds=opt.skuId.split(',');_commArr=_skuIds.map(function(i){return[i,'',opt.num||1,i,'1,0,0'].join(',');});_commlist=_commArr.join('$');}
var _opt={commlist:_commlist,source:opt.source,actId:opt.actId=='1'?"13":'',sid:opt.sid||me.sid,type:opt.isXnzt?'3':'0',locationid:me.getLocId(),reg:1,scene:2,sceneval:opt.isWq?'':'2',t:Math.random()};var jsonOpt={url:me.dealUrlParam('//wq.jd.com/deal/mshopcart/addCmdy?templete=1',_opt),callback:function(data){opt.sucFun&&opt.sucFun(data);},onerror:function(){opt.failFun&&opt.failFun();},onload:function(){opt.onload&&opt.onload();}};me.ajaxJsonp(jsonOpt);},addCart:function(opt){var me=this;if(!(opt.skuId||(opt.commArr&&opt.commArr.length))){console.error("加车传参错误，请检查参数");return;}
var skuIdArr=(opt.skuId||"").split(',');if(skuIdArr.length>1||opt.isWq||(opt.commArr&&opt.commArr.length)){me.addWqCart(opt);}else{me.addMjdCart(opt);}}};var a=new _mAddcartObj();window.AddcartToolObj={addCart:function(){a.addCart.apply(a,arguments);}};})();
